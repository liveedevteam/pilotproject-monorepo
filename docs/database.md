# Database Documentation

This document covers database setup, schema, operations, and best practices.

## Overview

The project uses **Drizzle ORM** with **PostgreSQL** via **Supabase** for database operations. The database package (`@repo/database`) provides schema definitions, database client, and type exports.

## Quick Start

```bash
# Setup and start database
pnpm setup:project <project-name>
pnpm supabase:start

# Push schema to database
pnpm db:push

# Open database management interface
pnpm db:studio
```

## Database Schema

### Current Tables

The schema is defined in `packages/database/src/schema.ts`:

#### Users Table

```typescript
export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  email: varchar("email", { length: 255 }).notNull().unique(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});
```

#### Posts Table

```typescript
export const posts = pgTable("posts", {
  id: serial("id").primaryKey(),
  title: varchar("title", { length: 255 }).notNull(),
  content: text("content"),
  authorId: serial("author_id").references(() => users.id),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});
```

### Relationships

- Posts belong to Users (one-to-many)
- Users can have multiple Posts
- Foreign key constraint: `posts.authorId` â†’ `users.id`

## Database Operations

### Development Commands

```bash
# Push schema changes directly (development)
pnpm db:push

# Generate migration files (production)
pnpm db:generate

# Run migrations
pnpm db:migrate

# Open Drizzle Studio
pnpm db:studio
```

### Schema Changes Workflow

#### Development (Direct Push)

1. Modify schema in `packages/database/src/schema.ts`
2. Run `pnpm db:push` to apply changes directly
3. Changes are applied immediately without migration files

#### Production (Migrations)

1. Modify schema in `packages/database/src/schema.ts`
2. Run `pnpm db:generate` to create migration files
3. Review generated migration in `packages/database/drizzle/` folder
4. Run `pnpm db:migrate` to apply migration
5. Commit migration files to version control

## Database Client

### Connection Setup

The database client is configured in `packages/database/src/client.ts`:

```typescript
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";

const connectionString = process.env.DATABASE_URL!;
const client = postgres(connectionString);
export const db = drizzle(client);
```

### Usage in API

```typescript
import { db } from "@repo/database";
import { users, posts } from "@repo/database/schema";

// Create user
const newUser = await db
  .insert(users)
  .values({
    name: "John Doe",
    email: "john@example.com",
  })
  .returning();

// Query users
const allUsers = await db.select().from(users);

// Query with relations
const usersWithPosts = await db
  .select()
  .from(users)
  .leftJoin(posts, eq(users.id, posts.authorId));
```

## Environment Configuration

### Local Development

Environment variables are automatically generated by setup script:

```bash
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:[port]/postgres
DIRECT_URL=postgresql://postgres:postgres@127.0.0.1:[port]/postgres
```

### Production

Set these environment variables:

```bash
DATABASE_URL=postgresql://username:password@host:port/database
DIRECT_URL=postgresql://username:password@host:port/database
```

## Drizzle Configuration

Configuration in `packages/database/drizzle.config.ts`:

```typescript
import type { Config } from "drizzle-kit";

export default {
  schema: "./src/schema.ts",
  out: "./drizzle",
  driver: "pg",
  dbCredentials: {
    connectionString: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

## Supabase Integration

### Local Development Setup

Each project gets isolated Supabase instance:

- **Unique Ports**: Based on project name hash
- **Docker Containers**: Isolated per project
- **Data Persistence**: Project-specific Docker volumes

### Services Included

- **PostgreSQL**: Database server
- **PostgREST**: Auto-generated REST API
- **Supabase Studio**: Database management interface
- **Auth**: Authentication service (optional)
- **Storage**: File storage service (optional)

### Access URLs

After running `pnpm supabase:start`:

- Database: `127.0.0.1:[db-port]`
- Studio: `http://127.0.0.1:[studio-port]`
- API: `http://127.0.0.1:[api-port]`

## Best Practices

### Schema Design

1. **Use descriptive table and column names**
2. **Include created_at timestamps for audit trails**
3. **Add proper constraints and indexes**
4. **Use appropriate data types**
5. **Document complex relationships**

### Migrations

1. **Always generate migrations for production**
2. **Review migration files before applying**
3. **Test migrations on staging environment**
4. **Keep migrations small and focused**
5. **Include rollback strategies**

### Performance

1. **Add indexes for frequently queried columns**
2. **Use proper join strategies**
3. **Limit result sets appropriately**
4. **Monitor query performance**
5. **Use connection pooling**

### Security

1. **Use environment variables for credentials**
2. **Apply principle of least privilege**
3. **Validate input data**
4. **Use parameterized queries (Drizzle handles this)**
5. **Regular security updates**

## Troubleshooting

### Common Issues

#### Connection Errors

```bash
# Check if Supabase is running
pnpm supabase:status

# Restart services
pnpm supabase:restart

# Check environment variables
cat packages/database/.env
```

#### Migration Issues

```bash
# Reset database (development only)
pnpm supabase:reset

# Check migration status
pnpm db:studio
```

#### Schema Sync Issues

```bash
# Force push schema
pnpm db:push

# Regenerate client
rm -rf packages/database/node_modules/.cache
pnpm install
```

### Performance Issues

1. **Use Drizzle Studio to analyze queries**
2. **Check for missing indexes**
3. **Monitor connection pool usage**
4. **Review query patterns**

### Data Issues

1. **Use Drizzle Studio for data inspection**
2. **Check foreign key constraints**
3. **Verify data types match schema**
4. **Review seed data if applicable**

## Advanced Features

### Custom Types

Add custom PostgreSQL types:

```typescript
import { customType } from "drizzle-orm/pg-core";

const customEnum = pgEnum("status", ["active", "inactive"]);
```

### Indexes

Add database indexes:

```typescript
import { index } from "drizzle-orm/pg-core";

export const emailIndex = index("email_idx").on(users.email);
```

### Complex Queries

Use Drizzle's query builder for complex operations:

```typescript
// Subqueries
const postsCount = db
  .select({ count: count() })
  .from(posts)
  .where(eq(posts.authorId, users.id));

const usersWithPostCount = await db
  .select({
    user: users,
    postsCount: postsCount,
  })
  .from(users);
```

### Transactions

Handle multiple operations atomically:

```typescript
await db.transaction(async tx => {
  const user = await tx
    .insert(users)
    .values({
      name: "John",
      email: "john@example.com",
    })
    .returning();

  await tx.insert(posts).values({
    title: "First Post",
    authorId: user[0].id,
  });
});
```
