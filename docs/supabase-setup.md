# Supabase Multi-Project Local Setup

This directory contains the configuration for running multiple isolated Supabase instances locally using Docker Compose with dynamic project names.

## Quick Start

### Method 1: Using the Setup Script (Recommended)

1. **Setup a new project environment:**

   ```bash
   ./scripts/setup-supabase-project.sh <project_name> [db_port] [api_port] [studio_port] [inbucket_port]
   ```

2. **Start Supabase services:**

   ```bash
   cd supabase
   docker compose up -d
   ```

3. **Access your services:**
   - Studio: http://localhost:[studio_port]
   - API: http://localhost:[api_port]
   - Database: localhost:[db_port]

### Method 2: Using pnpm Scripts (Legacy)

1. **Setup a new project environment:**

   ```bash
   pnpm setup:project my-project-name
   ```

2. **Start Supabase services:**
   ```bash
   pnpm supabase:start
   ```

## How It Works

### Dynamic Project Setup

The new setup script (`scripts/setup-supabase-project.sh`) generates project-specific configurations:

**Examples:**

```bash
# Use default ports
./scripts/setup-supabase-project.sh my-project

# Use custom ports for multiple projects
./scripts/setup-supabase-project.sh dev 5432 8000 3000 9000
./scripts/setup-supabase-project.sh test 5433 8001 3001 9001
./scripts/setup-supabase-project.sh staging 5434 8002 3002 9002
```

### Project Name Requirements

Project names must:

- Start with a letter or number
- Contain only letters, numbers, underscores, periods, and hyphens
- Be valid Docker container names

### Container and Volume Naming

- **Containers**: `supabase-[service]-[project-name]`
- **Volumes**: `supabase_[type]_[project-name]`

This ensures complete isolation between different project instances.

### Generated Files

When you run the setup script, the following files are created/updated:

- `supabase/docker-compose.override.yml` - Docker configuration with project-specific ports and names
- Project-specific Docker volumes for data persistence

### Template System

The setup uses:

- `docker-compose.override.template.yml` - Template with variable placeholders
- Script processing to replace `${PROJECT_NAME}`, `${DB_PORT}`, etc.
- Dynamic volume names for complete project isolation

### Docker Containers

Each project gets isolated Docker containers:

- `supabase-db-{project-name}` - PostgreSQL database
- `supabase-kong-{project-name}` - API gateway
- `supabase-auth-{project-name}` - Authentication service
- `supabase-rest-{project-name}` - PostgREST API
- `supabase-realtime-{project-name}` - Realtime service
- `supabase-storage-{project-name}` - File storage
- `supabase-studio-{project-name}` - Admin dashboard
- `supabase-inbucket-{project-name}` - Email testing

## Multiple Projects Example

You can run multiple projects simultaneously:

```bash
# Terminal 1 - Project A
cd /path/to/project-a
pnpm setup:project project-a
pnpm supabase:start
# Project A will use ports 54322, 54321, 54323, 54324 + hash_offset_a

# Terminal 2 - Project B
cd /path/to/project-b
pnpm setup:project project-b
pnpm supabase:start
# Project B will use ports 54322, 54321, 54323, 54324 + hash_offset_b
```

## Troubleshooting

### Port Conflicts

If you encounter port conflicts, you can:

1. Stop conflicting services: `pnpm supabase:stop`
2. Use a different project name to get different ports
3. Check what's using the ports: `lsof -i :54321`

### Reset Database

To completely reset your local database:

```bash
pnpm supabase:reset
```

### Check Service Status

To see which services are running:

```bash
pnpm supabase:status
```

## File Structure

```
supabase/
├── config.toml                              # Supabase configuration
├── docker-compose.override.template.yml     # Template for override
├── docker-compose.override.yml              # Generated (gitignored)
├── .env                                      # Generated (gitignored)
└── README.md                                # This file
```

## Environment Variables

All environment variables are automatically generated by the setup script:

- **JWT_SECRET**: Randomly generated secret for JWT tokens
- **ANON_KEY**: JWT token for anonymous access
- **SERVICE_ROLE_KEY**: JWT token for admin operations
- **DATABASE_URL**: Connection string with project-specific port
- **POSTGRES_PASSWORD**: Database password (change in production)

## Security Note

The generated JWT tokens and passwords are for local development only. For production deployments, use Supabase Cloud or properly secure your self-hosted instance.
